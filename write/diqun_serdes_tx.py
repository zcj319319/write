from ctypes import *
from time import sleep
# Import module
import ControlSPI

# Scan device
nRet = ControlSPI.VSI_ScanDevice(1)
if(nRet <= 0):
    print("No device connect!")
  #  exit()
else:
    print("Connected device number is:"+repr(nRet))

# Open device
nRet = ControlSPI.VSI_OpenDevice(ControlSPI.VSI_USBSPI,0,0)
if(nRet != ControlSPI.ERR_SUCCESS):
    print("Open device error!")
    #exit()
else:
    print("Open device success!")
# Initialize device
SPI_Init = ControlSPI.VSI_INIT_CONFIG()
SPI_Init.ClockSpeed = 1125000;
SPI_Init.ControlMode = 1;
SPI_Init.CPHA = 0;
SPI_Init.CPOL = 0;
SPI_Init.LSBFirst = 0;
SPI_Init.MasterMode = 1;
SPI_Init.SelPolarity = 0;
SPI_Init.TranBits = 8;

nRet = ControlSPI.VSI_InitSPI(ControlSPI.VSI_USBSPI,0,byref(SPI_Init))
if(nRet != ControlSPI.ERR_SUCCESS):
    print("Initialization device error!")
   # exit()
else:
    print("Initialization device success!")


write_buffer = (c_ubyte * 1024)()
read_buffer = (c_ubyte * 8192)()


#### function define
def read_spi_reg(addr0,addr1):
    write_buffer = (c_ubyte * 2)()
    read_buffer = (c_ubyte * 2)()
    write_buffer[0] = addr0
    write_buffer[1] = addr1
    nRet = ControlSPI.VSI_WriteReadBytes(ControlSPI.VSI_USBSPI, 0, 0, write_buffer, 2, read_buffer, 2)
    return read_buffer

def write_spi_reg(addr0,addr1,data):
    write_buffer = (c_ubyte * 3)()
    read_buffer = (c_ubyte * 2)()
    write_buffer[0] = addr0
    write_buffer[1] = addr1
    write_buffer[2] = data
    nRet = ControlSPI.VSI_WriteBytes(ControlSPI.VSI_USBSPI, 0, 0, write_buffer, 3)




def QUARTERRATE_1tap():
    write_spi_reg(0x10, 0x91, 0x40)  ##
    write_spi_reg(0x10, 0x9b, 0x40)  ##
    write_spi_reg(0x10, 0xa5, 0x40)  ##
    write_spi_reg(0x10, 0xaf, 0x40)  ##
    write_spi_reg(0x10, 0xb9, 0x40)  ##
    write_spi_reg(0x10, 0xc3, 0x40)  ##
    write_spi_reg(0x10, 0xcd, 0x40)  ##
    write_spi_reg(0x10, 0xd7, 0x40)  ##

def QUARTERRATE_2tap():
    write_spi_reg(0x10, 0x91, 0x43)  ##
    write_spi_reg(0x10, 0x9b, 0x43)  ##
    write_spi_reg(0x10, 0xa5, 0x43)  ##
    write_spi_reg(0x10, 0xaf, 0x43)  ##
    write_spi_reg(0x10, 0xb9, 0x43)  ##
    write_spi_reg(0x10, 0xc3, 0x43)  ##
    write_spi_reg(0x10, 0xcd, 0x43)  ##
    write_spi_reg(0x10, 0xd7, 0x43)  ##

def QUARTERRATE_3tap():
    write_spi_reg(0x10, 0x91, 0x44)  ##
    write_spi_reg(0x10, 0x9b, 0x44)  ##
    write_spi_reg(0x10, 0xa5, 0x44)  ##
    write_spi_reg(0x10, 0xaf, 0x44)  ##
    write_spi_reg(0x10, 0xb9, 0x44)  ##
    write_spi_reg(0x10, 0xc3, 0x44)  ##
    write_spi_reg(0x10, 0xcd, 0x44)  ##
    write_spi_reg(0x10, 0xd7, 0x44)  ##

def QUARTERRATE_4tap():
    write_spi_reg(0x10, 0x91, 0x48)  ##
    write_spi_reg(0x10, 0x9b, 0x48)  ##
    write_spi_reg(0x10, 0xa5, 0x48)  ##
    write_spi_reg(0x10, 0xaf, 0x48)  ##
    write_spi_reg(0x10, 0xb9, 0x48)  ##
    write_spi_reg(0x10, 0xc3, 0x48)  ##
    write_spi_reg(0x10, 0xcd, 0x48)  ##
    write_spi_reg(0x10, 0xd7, 0x48)  ##

def HALFRATE_1tap():
    write_spi_reg(0x10, 0x91, 0x60)  ##
    write_spi_reg(0x10, 0x9b, 0x60)  ##
    write_spi_reg(0x10, 0xa5, 0x60)  ##
    write_spi_reg(0x10, 0xaf, 0x60)  ##
    write_spi_reg(0x10, 0xb9, 0x60)  ##
    write_spi_reg(0x10, 0xc3, 0x60)  ##
    write_spi_reg(0x10, 0xcd, 0x60)  ##
    write_spi_reg(0x10, 0xd7, 0x60)  ##

def HALFRATE_2tap():
    write_spi_reg(0x10, 0x91, 0x63)  ##
    write_spi_reg(0x10, 0x9b, 0x63)  ##
    write_spi_reg(0x10, 0xa5, 0x63)  ##
    write_spi_reg(0x10, 0xaf, 0x63)  ##
    write_spi_reg(0x10, 0xb9, 0x63)  ##
    write_spi_reg(0x10, 0xc3, 0x63)  ##
    write_spi_reg(0x10, 0xcd, 0x63)  ##
    write_spi_reg(0x10, 0xd7, 0x63)  ##

def HALFRATE_3tap():
    write_spi_reg(0x10, 0x91, 0x64)  ##
    write_spi_reg(0x10, 0x9b, 0x64)  ##
    write_spi_reg(0x10, 0xa5, 0x64)  ##
    write_spi_reg(0x10, 0xaf, 0x64)  ##
    write_spi_reg(0x10, 0xb9, 0x64)  ##
    write_spi_reg(0x10, 0xc3, 0x64)  ##
    write_spi_reg(0x10, 0xcd, 0x64)  ##
    write_spi_reg(0x10, 0xd7, 0x64)  ##

def HALFRATE_4tap():
    write_spi_reg(0x10, 0x91, 0x68)  ##
    write_spi_reg(0x10, 0x9b, 0x68)  ##
    write_spi_reg(0x10, 0xa5, 0x68)  ##
    write_spi_reg(0x10, 0xaf, 0x68)  ##
    write_spi_reg(0x10, 0xb9, 0x68)  ##
    write_spi_reg(0x10, 0xc3, 0x68)  ##
    write_spi_reg(0x10, 0xcd, 0x68)  ##
    write_spi_reg(0x10, 0xd7, 0x68)  ##

def FFE_1tap():
    ##FFE 1-tap
    write_spi_reg(0x10,0x8e,0x00)  ## 1-tap FFE
    write_spi_reg(0x10,0x98,0x00)  ## 1-tap FFE
    write_spi_reg(0x10,0xA2,0x00)  ## 1-tap FFE
    write_spi_reg(0x10,0xAC,0x00)  ## 1-tap FFE
    write_spi_reg(0x10,0xB6,0x00)  ## 1-tap FFE
    write_spi_reg(0x10,0xC0,0x00)  ## 1-tap FFE
    write_spi_reg(0x10,0xCA,0x00)  ## 1-tap FFE
    write_spi_reg(0x10,0xD4,0x00)  ## 1-tap FFE

    write_spi_reg(0x10,0x8F,0xf4)  ##CH0 1-tap default settings
    write_spi_reg(0x10,0x99,0xf4)  ##CH1 1-tap default settings
    write_spi_reg(0x10,0xA3,0xf4)  ##CH2 1-tap default settings
    write_spi_reg(0x10,0xAD,0xf4)  ##CH3 1-tap default settings
    write_spi_reg(0x10,0xB7,0xf4)  ##CH4 1-tap default settings
    write_spi_reg(0x10,0xC1,0xf4)  ##CH5 1-tap default settings
    write_spi_reg(0x10,0xCB,0xf4)  ##CH6 1-tap default settings
    write_spi_reg(0x10,0xD5,0xf4)  ##CH7 1-tap default settings

    write_spi_reg(0x10,0x90,0x3c)  ##CH0 1-tap default settings
    write_spi_reg(0x10,0x9A,0x3c)  ##CH1 1-tap default settings
    write_spi_reg(0x10,0xA4,0x3c)  ##CH2 1-tap default settings
    write_spi_reg(0x10,0xAE,0x3c)  ##CH3 1-tap default settings
    write_spi_reg(0x10,0xB8,0x3c)  ##CH4 1-tap default settings
    write_spi_reg(0x10,0xC2,0x3c)  ##CH5 1-tap default settings
    write_spi_reg(0x10,0xCC,0x3c)  ##CH6 1-tap default settings
    write_spi_reg(0x10,0xD6,0x3c)  ##CH7 1-tap default settings

def FFE_2tap():
    ##FFE 2-tap
    write_spi_reg(0x10,0x8e,0x00)  ## 2-tap FFE
    write_spi_reg(0x10,0x98,0x00)  ## 2-tap FFE
    write_spi_reg(0x10,0xA2,0x00)  ## 2-tap FFE
    write_spi_reg(0x10,0xAC,0x00)  ## 2-tap FFE
    write_spi_reg(0x10,0xB6,0x00)  ## 2-tap FFE
    write_spi_reg(0x10,0xC0,0x00)  ## 2-tap FFE
    write_spi_reg(0x10,0xCA,0x00)  ## 2-tap FFE
    write_spi_reg(0x10,0xD4,0x00)  ## 2-tap FFE

    write_spi_reg(0x10,0x8F,0xc4)  ##CH0 2-tap default settings
    write_spi_reg(0x10,0x99,0xc4)  ##CH1 2-tap default settings
    write_spi_reg(0x10,0xA3,0xc4)  ##CH2 2-tap default settings
    write_spi_reg(0x10,0xAD,0xc4)  ##CH3 2-tap default settings
    write_spi_reg(0x10,0xB7,0xc4)  ##CH4 2-tap default settings
    write_spi_reg(0x10,0xC1,0xc4)  ##CH5 2-tap default settings
    write_spi_reg(0x10,0xCB,0xc4)  ##CH6 2-tap default settings
    write_spi_reg(0x10,0xD5,0xc4)  ##CH7 2-tap default settings

    write_spi_reg(0x10,0x90,0x3c)  ##CH0 2-tap default settings
    write_spi_reg(0x10,0x9A,0x3c)  ##CH1 2-tap default settings
    write_spi_reg(0x10,0xA4,0x3c)  ##CH2 2-tap default settings
    write_spi_reg(0x10,0xAE,0x3c)  ##CH3 2-tap default settings
    write_spi_reg(0x10,0xB8,0x3c)  ##CH4 2-tap default settings
    write_spi_reg(0x10,0xC2,0x3c)  ##CH5 2-tap default settings
    write_spi_reg(0x10,0xCC,0x3c)  ##CH6 2-tap default settings
    write_spi_reg(0x10,0xD6,0x3c)  ##CH7 2-tap default settings

def FFE_3tap():
    ##FFE 3-tap
    write_spi_reg(0x10,0x8e,0x14)  ## 3-tap FFE
    write_spi_reg(0x10,0x98,0x14)  ## 3-tap FFE
    write_spi_reg(0x10,0xA2,0x14)  ## 3-tap FFE
    write_spi_reg(0x10,0xAC,0x14)  ## 3-tap FFE
    write_spi_reg(0x10,0xB6,0x14)  ## 3-tap FFE
    write_spi_reg(0x10,0xC0,0x14)  ## 3-tap FFE
    write_spi_reg(0x10,0xCA,0x14)  ## 3-tap FFE
    write_spi_reg(0x10,0xD4,0x14)  ## 3-tap FFE

    write_spi_reg(0x10,0x8F,0xb4)  ##CH0 3-tap default settings
    write_spi_reg(0x10,0x99,0xb4)  ##CH1 3-tap default settings
    write_spi_reg(0x10,0xA3,0xb4)  ##CH2 3-tap default settings
    write_spi_reg(0x10,0xAD,0xb4)  ##CH3 3-tap default settings
    write_spi_reg(0x10,0xB7,0xb4)  ##CH4 3-tap default settings
    write_spi_reg(0x10,0xC1,0xb4)  ##CH5 3-tap default settings
    write_spi_reg(0x10,0xCB,0xb4)  ##CH6 3-tap default settings
    write_spi_reg(0x10,0xD5,0xb4)  ##CH7 3-tap default settings

    write_spi_reg(0x10,0x90,0x3c)  ##CH0 3-tap default settings
    write_spi_reg(0x10,0x9A,0x3c)  ##CH1 3-tap default settings
    write_spi_reg(0x10,0xA4,0x3c)  ##CH2 3-tap default settings
    write_spi_reg(0x10,0xAE,0x3c)  ##CH3 3-tap default settings
    write_spi_reg(0x10,0xB8,0x3c)  ##CH4 3-tap default settings
    write_spi_reg(0x10,0xC2,0x3c)  ##CH5 3-tap default settings
    write_spi_reg(0x10,0xCC,0x3c)  ##CH6 3-tap default settings
    write_spi_reg(0x10,0xD6,0x3c)  ##CH7 3-tap default settings

def FFE_4tap():
    ##FFE 4-tap
    write_spi_reg(0x10,0x8e,0x00)  ## 4-tap FFE
    write_spi_reg(0x10,0x98,0x00)  ## 4-tap FFE
    write_spi_reg(0x10,0xA2,0x00)  ## 4-tap FFE
    write_spi_reg(0x10,0xAC,0x00)  ## 4-tap FFE
    write_spi_reg(0x10,0xB6,0x00)  ## 4-tap FFE
    write_spi_reg(0x10,0xC0,0x00)  ## 4-tap FFE
    write_spi_reg(0x10,0xCA,0x00)  ## 4-tap FFE
    write_spi_reg(0x10,0xD4,0x00)  ## 4-tap FFE

    write_spi_reg(0x10,0x8F,0x98)  ##CH0 4-tap default settings
    write_spi_reg(0x10,0x99,0x98)  ##CH1 4-tap default settings
    write_spi_reg(0x10,0xA3,0x98)  ##CH2 4-tap default settings
    write_spi_reg(0x10,0xAD,0x98)  ##CH3 4-tap default settings
    write_spi_reg(0x10,0xB7,0x98)  ##CH4 4-tap default settings
    write_spi_reg(0x10,0xC1,0x98)  ##CH5 4-tap default settings
    write_spi_reg(0x10,0xCB,0x98)  ##CH6 4-tap default settings
    write_spi_reg(0x10,0xD5,0x98)  ##CH7 4-tap default settings

    write_spi_reg(0x10,0x90,0x3e)  ##CH0 4-tap default settings
    write_spi_reg(0x10,0x9A,0x3e)  ##CH1 4-tap default settings
    write_spi_reg(0x10,0xA4,0x3e)  ##CH2 4-tap default settings
    write_spi_reg(0x10,0xAE,0x3e)  ##CH3 4-tap default settings
    write_spi_reg(0x10,0xB8,0x3e)  ##CH4 4-tap default settings
    write_spi_reg(0x10,0xC2,0x3e)  ##CH5 4-tap default settings
    write_spi_reg(0x10,0xCC,0x3e)  ##CH6 4-tap default settings
    write_spi_reg(0x10,0xD6,0x3e)  ##CH7 4-tap default settings

write_spi_reg(0x10,0x7d,0x0c)  ## refclk divider div 24
####PLL KVCO
write_spi_reg(0x11,0x46,0x2b) ####
####PLL FBC divider by 60
write_spi_reg(0x11,0x48,0x3a) ####div  by 58
##write_spi_reg(0x11,0x48,0x3c) ####div  by 60
##write_spi_reg(0x11,0x48,0x40) ####div by 64
####PLL temp compensation disabled
write_spi_reg(0x11,0x3a,0x10) ####
##DCCDLL setting from CH0 to CH7
write_spi_reg(0x10,0x92,0x84)
write_spi_reg(0x10,0x9c,0x84)
write_spi_reg(0x10,0xa6,0x84)
write_spi_reg(0x10,0xb0,0x84)
write_spi_reg(0x10,0xba,0x84)
write_spi_reg(0x10,0xc4,0x84)
write_spi_reg(0x10,0xce,0x84)
write_spi_reg(0x10,0xd8,0x84)

FFE_2tap()
HALFRATE_2tap()

####datarate 40-quarter rate,60-halfrate,70-fullrate
##write_spi_reg(0x10,0x91,0x70)
##write_spi_reg(0x10,0x9b,0x70)
##write_spi_reg(0x10,0xa5,0x70)
##write_spi_reg(0x10,0xaf,0x70)
##write_spi_reg(0x10,0xb9,0x70)
##write_spi_reg(0x10,0xc3,0x70)
##write_spi_reg(0x10,0xcd,0x70)
##write_spi_reg(0x10,0xd7,0x70)
###TXREADY bypass
write_spi_reg(0x10,0x87,0x04)
## pattern generator clk pattern
write_spi_reg(0x10,0x8d,0x91)
write_spi_reg(0x10,0x97,0x91)
write_spi_reg(0x10,0xa1,0x91)
write_spi_reg(0x10,0xab,0x91)
write_spi_reg(0x10,0xb5,0x91)
write_spi_reg(0x10,0xbf,0x91)
write_spi_reg(0x10,0xc9,0x91)
write_spi_reg(0x10,0xd3,0x91)
##enable
write_spi_reg(0x11,0x4a,0x56)
write_spi_reg(0x10,0x89,0xf0)
write_spi_reg(0x10,0x89,0xf1)
####dccdll trigger
write_spi_reg(0x10,0xe3,0x02)
write_spi_reg(0x10,0xef,0x02)
write_spi_reg(0x10,0xfb,0x02)
write_spi_reg(0x11,0x07,0x02)
write_spi_reg(0x11,0x13,0x02)
write_spi_reg(0x11,0x1f,0x02)
write_spi_reg(0x11,0x2b,0x02)
write_spi_reg(0x11,0x37,0x02)
####toggle
write_spi_reg(0x10,0xe3,0x00)
write_spi_reg(0x10,0xef,0x00)
write_spi_reg(0x10,0xfb,0x00)
write_spi_reg(0x11,0x07,0x00)
write_spi_reg(0x11,0x13,0x00)
write_spi_reg(0x11,0x1f,0x00)
write_spi_reg(0x11,0x2b,0x00)
write_spi_reg(0x11,0x37,0x00)
####txready enable
write_spi_reg(0x10,0x87,0x0c)

####PLLSetting
write_spi_reg(0x11,0x45,0x10) #### IND SW

#####TP set
##write_spi_reg(0x11,0x59,0x0e)
##write_spi_reg(0x10,0x86,0x80)
##write_spi_reg(0x10,0x89,0xf2)
##write_spi_reg(0x11,0x4a,0xd6)
##write_spi_reg(0x11,0x4b,0xa9)
##write_spi_reg(0x10,0x89,0xf3)

## pattern generator prbs7 pattern
write_spi_reg(0x10,0x8d,0x80)
write_spi_reg(0x10,0x97,0x80)
write_spi_reg(0x10,0xa1,0x80)
write_spi_reg(0x10,0xab,0x80)
write_spi_reg(0x10,0xb5,0x80)
write_spi_reg(0x10,0xbf,0x80)
write_spi_reg(0x10,0xc9,0x80)
write_spi_reg(0x10,0xd3,0x80)

write_spi_reg(0x10,0x8d,0xa0)
write_spi_reg(0x10,0x97,0xa0)
write_spi_reg(0x10,0xa1,0xa0)
write_spi_reg(0x10,0xab,0xa0)
write_spi_reg(0x10,0xb5,0xa0)
write_spi_reg(0x10,0xbf,0xa0)
write_spi_reg(0x10,0xc9,0xa0)
write_spi_reg(0x10,0xd3,0xa0)